---
import BaseLayout from '@layouts/BaseLayout.astro';
import ProductCard from '@components/ProductCard.astro';
import { getProducts, getCategories } from '@lib/api';

// Fetch data from API
let products: any[] = [];
let categories: any[] = [];

try {
  products = await getProducts();
  categories = await getCategories();
} catch (e) {
  // Placeholder data
  products = [
    {
      _id: 'magnetic-stethoscope-holder',
      name: 'Magnetic Stethoscope Holder',
      slug: 'magnetic-stethoscope-holder',
      price: 18.99,
      shortDescription: 'Strong magnet keeps your stethoscope secure and accessible.',
      categoryId: 'stethoscope-holders',
    },
    {
      _id: 'velcro-stethoscope-holder',
      name: 'Hook & Loop Velcro Stethoscope Holder',
      slug: 'velcro-stethoscope-holder',
      price: 18.99,
      shortDescription: 'Secure velcro attachment for easy one-hand access.',
      categoryId: 'stethoscope-holders',
    },
    {
      _id: 'nurse-fanny-pack',
      name: 'Nurse Fanny Pack',
      slug: 'nurse-fanny-pack',
      price: 22.99,
      compareAtPrice: 23.99,
      shortDescription: 'Keep all your essentials organized and within reach.',
      categoryId: 'nurse-accessories',
    },
  ];
  categories = [
    { _id: 'stethoscope-holders', name: 'Stethoscope Holders', slug: 'stethoscope-holders' },
    { _id: 'nurse-accessories', name: 'Nurse Accessories', slug: 'nurse-accessories' },
  ];
}

// Get category filter from URL
const url = new URL(Astro.request.url);
const categoryFilter = url.searchParams.get('category');

// Filter products by category
const filteredProducts = categoryFilter
  ? products.filter(p => p.category?.slug === categoryFilter || p.categoryId === categoryFilter)
  : products;
---

<BaseLayout
  title="Shop"
  description="Shop premium medical accessories at Bobcat Medical. Stethoscope holders, nurse fanny packs, and more."
>
  <!-- Hero -->
  <section class="bg-bobcat-800 text-white py-16">
    <div class="container-width text-center">
      <h1 class="font-display text-4xl md:text-5xl font-bold mb-4">Shop All Products</h1>
      <p class="text-bobcat-100 text-lg max-w-2xl mx-auto">
        Premium medical accessories designed for healthcare professionals who demand quality.
      </p>
    </div>
  </section>

  <!-- Products Grid -->
  <section class="section-padding bg-warm-50">
    <div class="container-width">
      <!-- Category Filter -->
      <div class="flex flex-wrap gap-2 mb-8 justify-center">
        <a
          href="/shop"
          class={`px-4 py-2 rounded-full font-medium transition-colors ${
            !categoryFilter
              ? 'bg-bobcat-600 text-white'
              : 'bg-white text-warm-700 hover:bg-bobcat-100'
          }`}
        >
          All
        </a>
        {categories.map((category) => (
          <a
            href={`/shop?category=${category.slug}`}
            class={`px-4 py-2 rounded-full font-medium transition-colors ${
              categoryFilter === category.slug
                ? 'bg-bobcat-600 text-white'
                : 'bg-white text-warm-700 hover:bg-bobcat-100'
            }`}
          >
            {category.name}
          </a>
        ))}
      </div>

      <!-- Products -->
      {filteredProducts.length > 0 ? (
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8">
          {filteredProducts.map((product) => (
            <ProductCard
              id={product._id}
              name={product.name}
              slug={product.slug}
              price={product.price}
              compareAtPrice={product.compareAtPrice}
              image={product.images?.[0]?.src}
              category={product.category?.name}
              shortDescription={product.shortDescription}
            />
          ))}
        </div>
      ) : (
        <div class="text-center py-16">
          <svg class="w-16 h-16 text-warm-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
          </svg>
          <h2 class="font-display text-xl font-bold text-warm-700 mb-2">No products found</h2>
          <p class="text-warm-500 mb-4">Try selecting a different category or check back later.</p>
          <a href="/shop" class="btn-primary">View All Products</a>
        </div>
      )}
    </div>
  </section>
</BaseLayout>
