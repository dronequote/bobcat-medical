---
import AdminLayout from '@layouts/AdminLayout.astro';

const { id } = Astro.params;
---

<AdminLayout title="Edit Blog Post">
  <div class="mb-6">
    <a href="/admin/blog" class="text-bobcat-600 hover:text-bobcat-700 font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Back
    </a>
  </div>

  <div id="loading" class="admin-card text-center py-12">
    <div class="animate-spin w-8 h-8 border-4 border-bobcat-200 border-t-bobcat-600 rounded-full mx-auto mb-4"></div>
    <p class="text-warm-600">Loading post...</p>
  </div>

  <form id="form" class="hidden grid lg:grid-cols-3 gap-6">
    <input type="hidden" id="postId" value={id} />

    <div class="lg:col-span-2 space-y-6">
      <div class="admin-card space-y-4">
        <div>
          <label for="title" class="label">Title *</label>
          <input type="text" id="title" name="title" class="input-field" required />
        </div>
        <div>
          <label for="slug" class="label">URL Slug</label>
          <input type="text" id="slug" name="slug" class="input-field" />
        </div>
        <div>
          <label for="excerpt" class="label">Excerpt</label>
          <textarea id="excerpt" name="excerpt" rows="2" class="input-field" maxlength="300"></textarea>
        </div>
        <div>
          <label for="content" class="label">Content (Markdown)</label>
          <textarea id="content" name="content" rows="15" class="input-field font-mono text-sm"></textarea>
        </div>
      </div>
    </div>

    <div class="space-y-6">
      <div class="admin-card space-y-4">
        <div>
          <label for="coverImage" class="label">Cover Image URL</label>
          <input type="text" id="coverImage" name="coverImage" class="input-field" />
        </div>
        <div>
          <label for="author" class="label">Author</label>
          <input type="text" id="author" name="author" class="input-field" />
        </div>
        <div>
          <label for="tags" class="label">Tags (comma separated)</label>
          <input type="text" id="tags" name="tags" class="input-field" placeholder="Nursing, Tips" />
        </div>
        <label class="flex items-center gap-3">
          <input type="checkbox" id="published" name="published" class="w-5 h-5 rounded border-warm-300 text-bobcat-600" />
          <span>Published</span>
        </label>
      </div>

      <div id="error" class="hidden bg-red-50 text-red-700 p-3 rounded-lg text-sm"></div>

      <button type="submit" id="submit" class="btn-primary w-full">Save Changes</button>

      <button type="button" id="delete-btn" class="w-full px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition-colors">
        Delete Post
      </button>
    </div>
  </form>
</AdminLayout>

<script>
  import { getBlogPost, updateBlogPost, deleteBlogPost } from '@lib/api';
  import { isAdminLoggedIn } from '@lib/admin-auth';

  if (!isAdminLoggedIn()) window.location.href = '/admin';

  const postId = (document.getElementById('postId') as HTMLInputElement)?.value;
  const form = document.getElementById('form') as HTMLFormElement;
  const loadingEl = document.getElementById('loading');
  const errorEl = document.getElementById('error');
  const submitBtn = document.getElementById('submit');
  const deleteBtn = document.getElementById('delete-btn');

  // Form fields
  const titleInput = document.getElementById('title') as HTMLInputElement;
  const slugInput = document.getElementById('slug') as HTMLInputElement;
  const excerptInput = document.getElementById('excerpt') as HTMLTextAreaElement;
  const contentInput = document.getElementById('content') as HTMLTextAreaElement;
  const coverImageInput = document.getElementById('coverImage') as HTMLInputElement;
  const authorInput = document.getElementById('author') as HTMLInputElement;
  const tagsInput = document.getElementById('tags') as HTMLInputElement;
  const publishedInput = document.getElementById('published') as HTMLInputElement;

  // Load post data
  async function loadPost() {
    try {
      const post = await getBlogPost(postId);

      titleInput.value = post.title || '';
      slugInput.value = post.slug || '';
      excerptInput.value = post.excerpt || '';
      contentInput.value = post.content || '';
      coverImageInput.value = post.coverImage || '';
      authorInput.value = post.author || 'Bobcat Medical Team';
      tagsInput.value = (post.tags || []).join(', ');
      publishedInput.checked = post.published || false;

      loadingEl?.classList.add('hidden');
      form?.classList.remove('hidden');
    } catch (error: any) {
      if (loadingEl) {
        loadingEl.innerHTML = `
          <div class="text-red-600">
            <p class="font-medium">Failed to load post</p>
            <p class="text-sm mt-1">${error.message}</p>
            <a href="/admin/blog" class="btn-secondary mt-4 inline-block">Back to Blog</a>
          </div>
        `;
      }
    }
  }

  loadPost();

  // Handle form submit
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorEl?.classList.add('hidden');
    if (submitBtn) { submitBtn.textContent = 'Saving...'; submitBtn.setAttribute('disabled', 'true'); }

    const formData = new FormData(form);
    const tags = (formData.get('tags') as string || '').split(',').map(t => t.trim()).filter(Boolean);

    try {
      await updateBlogPost(postId, {
        title: formData.get('title') as string,
        slug: formData.get('slug') as string || undefined,
        excerpt: formData.get('excerpt') as string,
        content: formData.get('content') as string,
        coverImage: formData.get('coverImage') as string || undefined,
        author: formData.get('author') as string || 'Bobcat Medical Team',
        tags,
        published: formData.get('published') === 'on',
        publishedAt: formData.get('published') === 'on' ? new Date().toISOString() : undefined,
      });
      window.location.href = '/admin/blog';
    } catch (error: any) {
      if (errorEl) { errorEl.textContent = error.message; errorEl.classList.remove('hidden'); }
    } finally {
      if (submitBtn) { submitBtn.textContent = 'Save Changes'; submitBtn.removeAttribute('disabled'); }
    }
  });

  // Handle delete
  deleteBtn?.addEventListener('click', async () => {
    if (!confirm('Are you sure you want to delete this blog post? This cannot be undone.')) return;

    deleteBtn.textContent = 'Deleting...';
    deleteBtn.setAttribute('disabled', 'true');

    try {
      await deleteBlogPost(postId);
      window.location.href = '/admin/blog';
    } catch (error: any) {
      alert('Failed to delete: ' + error.message);
      deleteBtn.textContent = 'Delete Post';
      deleteBtn.removeAttribute('disabled');
    }
  });
</script>
