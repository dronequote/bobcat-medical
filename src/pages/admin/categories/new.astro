---
import AdminLayout from '@layouts/AdminLayout.astro';
---

<AdminLayout title="Add Category">
  <div class="mb-6">
    <a href="/admin/categories" class="text-bobcat-600 hover:text-bobcat-700 font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Back
    </a>
  </div>

  <form id="form" class="max-w-2xl">
    <div class="admin-card space-y-4">
      <div>
        <label for="name" class="label">Category Name *</label>
        <input type="text" id="name" name="name" class="input-field" required />
      </div>
      <div>
        <label for="slug" class="label">URL Slug</label>
        <input type="text" id="slug" name="slug" class="input-field" placeholder="auto-generated" />
      </div>
      <div>
        <label for="description" class="label">Description</label>
        <textarea id="description" name="description" rows="3" class="input-field"></textarea>
      </div>
      <div>
        <label for="image" class="label">Image URL</label>
        <input type="text" id="image" name="image" class="input-field" />
      </div>
      <div>
        <label for="order" class="label">Display Order</label>
        <input type="number" id="order" name="order" class="input-field w-32" value="0" />
      </div>

      <div id="error" class="hidden bg-red-50 text-red-700 p-3 rounded-lg text-sm"></div>

      <button type="submit" id="submit" class="btn-primary">Create Category</button>
    </div>
  </form>
</AdminLayout>

<script>
  import { createCategory } from '@lib/api';
  import { isAdminLoggedIn } from '@lib/admin-auth';

  if (!isAdminLoggedIn()) window.location.href = '/admin';

  const form = document.getElementById('form') as HTMLFormElement;
  const nameInput = document.getElementById('name') as HTMLInputElement;
  const slugInput = document.getElementById('slug') as HTMLInputElement;
  const errorEl = document.getElementById('error');
  const submitBtn = document.getElementById('submit');

  nameInput?.addEventListener('input', () => {
    if (slugInput && !slugInput.dataset.manual) {
      slugInput.value = nameInput.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    }
  });

  slugInput?.addEventListener('input', () => { slugInput.dataset.manual = 'true'; });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorEl?.classList.add('hidden');
    if (submitBtn) { submitBtn.textContent = 'Creating...'; submitBtn.setAttribute('disabled', 'true'); }

    const formData = new FormData(form);

    try {
      await createCategory({
        name: formData.get('name') as string,
        slug: formData.get('slug') as string || undefined,
        description: formData.get('description') as string,
        image: formData.get('image') as string || undefined,
        order: parseInt(formData.get('order') as string) || 0,
      });
      window.location.href = '/admin/categories';
    } catch (error: any) {
      if (errorEl) { errorEl.textContent = error.message; errorEl.classList.remove('hidden'); }
    } finally {
      if (submitBtn) { submitBtn.textContent = 'Create Category'; submitBtn.removeAttribute('disabled'); }
    }
  });
</script>
